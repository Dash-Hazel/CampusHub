<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª - –ú–ª–∞–¥ –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        body { padding-top: 100px; }
        .admin-section { margin-bottom: 60px; }
        .admin-section h2 { border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 30px; }
        .image-input-group { margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        
        /* NEW: User Management Styles */
        .users-grid { margin-top: 20px; }
        .users-table { overflow-x: auto; }
        .users-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        .users-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }
        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        .users-table tr:hover {
            background: #f8f9fa;
        }
        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
        }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        
        .admin-queue-item {
            background: white;
            border: 1px solid #eaeaea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .queue-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }
        .role-select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>–ú–ª–∞–¥ –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç - –ê–¥–º–∏–Ω</h1>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ</p>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">‚Üê –ù–∞–∑–∞–¥ –∫—ä–º —Å–∞–π—Ç–∞</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Article Publishing Section -->
        <section class="admin-section">
            <h2>–ü—É–±–ª–∏–∫—É–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç–∏–∏</h2>
            <form id="articleForm">
                <div class="form-group">
                    <input type="text" id="title" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞" required>
                </div>
                <div class="form-group">
                    <textarea id="excerpt" placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ (—â–µ —Å–µ –ø–æ–∫–∞–∂–µ –Ω–∞ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞)" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <textarea id="content" placeholder="–ü—ä–ª–µ–Ω —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞..." rows="10" required></textarea>
                </div>
                <div class="form-group">
                    <input type="text" id="author" placeholder="–ê–≤—Ç–æ—Ä" required>
                </div>
                <div class="form-group">
                    <select id="category" required>
                        <option value="news">–ù–æ–≤–∏–Ω–∏</option>
                        <option value="interview">–ò–Ω—Ç–µ—Ä–≤—é</option>
                        <option value="opinion">–ú–Ω–µ–Ω–∏–µ</option>
                        <option value="culture">–ö—É–ª—Ç—É—Ä–∞</option>
                    </select>
                </div>
                
                <!-- FIXED: Multiple image inputs with unique IDs -->
                <div class="image-input-group">
                    <h4>–°–Ω–∏–º–∫–∏ –∑–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞ (–¥–æ 6 —Å–Ω–∏–º–∫–∏)</h4>
                    
                    <div class="form-group">
                        <label for="articleImage1">–û—Å–Ω–æ–≤–Ω–∞ —Å–Ω–∏–º–∫–∞:</label>
                        <input type="url" id="articleImage1" placeholder="https://example.com/image1.jpg">
                        <small>URL –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∞ —Å–Ω–∏–º–∫–∞</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="articleImage2">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ —Å–Ω–∏–º–∫–∞ 2:</label>
                        <input type="url" id="articleImage2" placeholder="https://example.com/image2.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label for="articleImage3">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ —Å–Ω–∏–º–∫–∞ 3:</label>
                        <input type="url" id="articleImage3" placeholder="https://example.com/image3.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label for="articleImage4">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ —Å–Ω–∏–º–∫–∞ 4:</label>
                        <input type="url" id="articleImage4" placeholder="https://example.com/image4.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label for="articleImage5">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ —Å–Ω–∏–º–∫–∞ 5:</label>
                        <input type="url" id="articleImage5" placeholder="https://example.com/image5.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label for="articleImage6">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ —Å–Ω–∏–º–∫–∞ 6:</label>
                        <input type="url" id="articleImage6" placeholder="https://example.com/image6.jpg">
                    </div>
                </div>
                
                <button type="submit" class="btn">–ü—É–±–ª–∏–∫—É–≤–∞–π —Å—Ç–∞—Ç–∏—è</button>
            </form>
            <div id="articleMessage" class="form-message"></div>
        </section>

        <!-- Calendar Management Section -->
        <section class="admin-section" style="padding: 40px 0; background: #f8f9fa; margin-top: 40px; border-radius: 10px;">
            <div class="container">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–∞</h2>
                <div class="admin-container">
                    <!-- Add Event Form -->
                    <div class="admin-form-section">
                        <h3>–î–æ–±–∞–≤–∏ –Ω–æ–≤–æ —Å—ä–±–∏—Ç–∏–µ</h3>
                        <form id="eventForm">
                            <input type="text" id="eventTitle" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ" required>
                            <textarea id="eventDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
                            <input type="date" id="eventDate" required>
                            <input type="time" id="eventTime" required>
                            <input type="text" id="eventLocation" placeholder="–ú—è—Å—Ç–æ" required>
                            <button type="submit" class="btn">–î–æ–±–∞–≤–∏ —Å—ä–±–∏—Ç–∏–µ</button>
                        </form>
                        <div id="eventMessage" class="form-message"></div>
                    </div>

                    <!-- Events List -->
                    <div class="admin-events-section">
                        <h3>–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏ —Å—ä–±–∏—Ç–∏—è</h3>
                        <div id="adminEventsList" class="events-list">
                            <!-- Events will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- NEW: User Management Section -->
        <section class="admin-section" style="margin-top: 40px;">
            <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</h2>
            <div id="usersContainer" class="users-grid">
                –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏...
            </div>
        </section>

        <!-- NEW: Articles Waiting for Approval -->
        <section class="admin-section" style="margin-top: 40px; background: #fff3cd; border: 1px solid #ffeaa7;">
            <h2>üìã –°—Ç–∞—Ç–∏–∏ –∑–∞ –æ–∫–æ–Ω—á–∞—Ç–µ–ª–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∏–µ</h2>
            <div id="adminQueueContainer" class="articles-grid">
                –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç–∏–∏...
            </div>
            
            <!-- Debug Tools - NOW INSIDE THE SECTION -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <h4>üîß –î–µ–±—ä–≥ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</h4>
                <button onclick="debugAdminQueue()" style="margin-right: 10px; padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    –î–µ–±—ä–≥ –æ–ø–∞—à–∫–∞
                </button>
                <button onclick="fixQueueIssues()" style="margin-right: 10px; padding: 8px 15px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    –ü–æ–ø—Ä–∞–≤–∏ –æ–ø–∞—à–∫–∞
                </button>
                <button onclick="loadArticleQueue()" style="padding: 8px 15px; background: #f39c12; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    –ü—Ä–µ–∑–∞—Ä–µ–¥–∏
                </button>
            </div>
        </section>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2023 –ö–ª—É–± "–ú–ª–∞–¥ –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç". –í—Å–∏—á–∫–∏ –ø—Ä–∞–≤–∞ –∑–∞–ø–∞–∑–µ–Ω–∏.</p>
        </div>
    </footer>

    <script>
        // ========== ADMIN ROLE CHECK ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîß Admin page loading, checking permissions...');
            
            // Wait for auth to initialize
            await new Promise(resolve => {
                if (auth.currentUser) {
                    resolve();
                } else {
                    const unsubscribe = auth.onAuthStateChanged((user) => {
                        unsubscribe();
                        resolve();
                    });
                }
            });
            
            const user = auth.currentUser;
            console.log('üîß Current user:', user?.email);
            
            if (!user) {
                alert('–ú–æ–ª—è, –≤–ª–µ–∑—Ç–µ –≤ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –∑–∞ –¥–æ—Å—Ç—ä–ø –¥–æ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∞.');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                const userRef = db.ref('users/' + user.uid);
                const snapshot = await userRef.once('value');
                
                console.log('üîß User snapshot exists:', snapshot.exists());
                
                if (!snapshot.exists()) {
                    alert('–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏—è—Ç –ø—Ä–æ—Ñ–∏–ª –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏.');
                    window.location.href = 'index.html';
                    return;
                }
                
                const userData = snapshot.val();
                const userRole = userData?.role;
                
                console.log('üîß User role from DB:', userRole);
                
                if (userRole !== 'admin') {
                    alert('–ù—è–º–∞—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏ –ø—Ä–∞–≤–∞ –∑–∞ –¥–æ—Å—Ç—ä–ø –¥–æ —Ç–∞–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞. –í–∞—à–∞—Ç–∞ —Ä–æ–ª—è: ' + (userRole || '–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'));
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('‚úÖ Access granted! User is admin.');
                
                // Load admin features
                loadUserManagement();
                loadArticleQueue();
                loadEvents();
                
            } catch (error) {
                console.error('‚ùå Error in admin check:', error);
                alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–∞–≤–∞—Ç–∞: ' + error.message);
                window.location.href = 'index.html';
            }
        });

        // ========== ARTICLE PUBLISHING FORM ==========
        document.getElementById('articleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '–ü—É–±–ª–∏–∫—É–≤–∞–Ω–µ...';
            submitBtn.disabled = true;
            
            const articleData = {
                title: document.getElementById('title').value,
                excerpt: document.getElementById('excerpt').value,
                content: document.getElementById('content').value,
                author: document.getElementById('author').value,
                category: document.getElementById('category').value,
                date: new Date().toISOString(),
                imageUrl: document.getElementById('articleImage1').value || '',
                imageUrl2: document.getElementById('articleImage2').value || '',
                imageUrl3: document.getElementById('articleImage3').value || '',
                imageUrl4: document.getElementById('articleImage4').value || '',
                imageUrl5: document.getElementById('articleImage5').value || '',
                imageUrl6: document.getElementById('articleImage6').value || ''
            };

            // Remove empty image fields
            Object.keys(articleData).forEach(key => {
                if (key.startsWith('imageUrl') && articleData[key] === '') {
                    delete articleData[key];
                }
            });

            db.ref('articles').push(articleData)
                .then(() => {
                    document.getElementById('articleMessage').innerHTML = 
                        '<div class="success-message">‚úÖ –°—Ç–∞—Ç–∏—è—Ç–∞ –µ –ø—É–±–ª–∏–∫—É–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</div>';
                    document.getElementById('articleForm').reset();
                })
                .catch((error) => {
                    document.getElementById('articleMessage').innerHTML = 
                        '<div class="error-message">‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫—É–≤–∞–Ω–µ</div>';
                    console.error('Error:', error);
                })
                .finally(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
        });

        // ========== CALENDAR MANAGEMENT ==========
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('eventTitle').value;
            const description = document.getElementById('eventDescription').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const location = document.getElementById('eventLocation').value;
            
            if (!title || !date || !time || !location) {
                alert('–ú–æ–ª—è, –ø–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞');
                return;
            }
            
            const dateTimeString = `${date}T${time}`;
            const timestamp = new Date(dateTimeString).getTime();
            
            if (isNaN(timestamp)) {
                alert('–ù–µ–≤–∞–ª–∏–¥–Ω–∞ –¥–∞—Ç–∞ –∏–ª–∏ —á–∞—Å');
                return;
            }
            
            const eventData = {
                title: title,
                description: description,
                location: location,
                timestamp: timestamp,
                created: new Date().getTime()
            };
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '–î–æ–±–∞–≤—è–Ω–µ...';
            submitBtn.disabled = true;
            
            db.ref('events').push(eventData)
                .then(() => {
                    document.getElementById('eventMessage').innerHTML = 
                        '<div class="success-message">‚úÖ –°—ä–±–∏—Ç–∏–µ—Ç–æ –µ –¥–æ–±–∞–≤–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!</div>';
                    document.getElementById('eventForm').reset();
                    loadEvents();
                })
                .catch((error) => {
                    document.getElementById('eventMessage').innerHTML = 
                        '<div class="error-message">‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ</div>';
                    console.error('Error:', error);
                })
                .finally(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
        });

        // Load events function
        function loadEvents() {
            db.ref('events').orderByChild('timestamp').once('value')
                .then((snapshot) => {
                    const eventsContainer = document.getElementById('adminEventsList');
                    eventsContainer.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        eventsContainer.innerHTML = '<div class="no-events">–í—Å–µ –æ—â–µ –Ω—è–º–∞ —Å—ä–±–∏—Ç–∏—è</div>';
                        return;
                    }
                    
                    const now = new Date().getTime();
                    let hasEvents = false;
                    
                    snapshot.forEach((childSnapshot) => {
                        const event = childSnapshot.val();
                        const eventId = childSnapshot.key;
                        const eventDate = new Date(event.timestamp);
                        
                        const isUpcoming = eventDate.getTime() > new Date().getTime();
                        const eventDiv = document.createElement('div');
                        eventDiv.className = `admin-event-card ${isUpcoming ? 'upcoming' : 'past'}`;
                        
                        const dateString = eventDate.toLocaleDateString('bg-BG', { 
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        eventDiv.innerHTML = `
                            <button class="delete-event-btn" onclick="deleteEvent('${eventId}')">‚úï</button>
                            <div class="admin-event-date">
                                <strong>${dateString}</strong>
                            </div>
                            <h3 class="admin-event-title">${event.title}</h3>
                            ${event.description ? `<p class="admin-event-description">${event.description}</p>` : ''}
                            <p class="admin-event-location">üìç ${event.location}</p>
                        `;
                        
                        eventsContainer.appendChild(eventDiv);
                        hasEvents = true;
                    });
                    
                    if (!hasEvents) {
                        eventsContainer.innerHTML = '<div class="no-events">–í—Å–µ –æ—â–µ –Ω—è–º–∞ —Å—ä–±–∏—Ç–∏—è</div>';
                    }
                })
                .catch((error) => {
                    console.error('Error loading events:', error);
                    document.getElementById('adminEventsList').innerHTML = 
                        '<div class="no-events">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å—ä–±–∏—Ç–∏—è—Ç–∞</div>';
                });
        }

        function deleteEvent(eventId) {
            if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–≤–∞ —Å—ä–±–∏—Ç–∏–µ?')) {
                db.ref('events/' + eventId).remove()
                    .then(() => {
                        document.getElementById('eventMessage').innerHTML = 
                            '<div class="success-message">‚úÖ –°—ä–±–∏—Ç–∏–µ—Ç–æ –µ –∏–∑—Ç—Ä–∏—Ç–æ —É—Å–ø–µ—à–Ω–æ!</div>';
                        loadEvents();
                    })
                    .catch((error) => {
                        console.error('Error deleting event:', error);
                        document.getElementById('eventMessage').innerHTML = 
                            '<div class="error-message">‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ</div>';
                    });
            }
        }

        // ========== USER MANAGEMENT FUNCTIONS ==========
        async function loadUserManagement() {
            try {
                const snapshot = await db.ref('users').once('value');
                const usersContainer = document.getElementById('usersContainer');
                
                if (!snapshot.exists()) {
                    usersContainer.innerHTML = '<p>–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏.</p>';
                    return;
                }
                
                let html = '<div class="users-table">';
                html += `
                    <table>
                        <thead>
                            <tr>
                                <th>–ò–º–µ</th>
                                <th>–ò–º–µ–π–ª</th>
                                <th>–†–æ–ª—è</th>
                                <th>–°—Ç–∞—Ç–∏–∏</th>
                                <th>–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    const userId = childSnapshot.key;
                    
                    if (userId === auth.currentUser.uid) return;
                    
                    const registerDate = user.createdAt ? 
                        new Date(user.createdAt).toLocaleDateString('bg-BG') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    
                    html += `
                        <tr>
                            <td>${user.displayName || '–ù—è–º–∞ –∏–º–µ'}</td>
                            <td>${user.email || '–ù—è–º–∞ –∏–º–µ–π–ª'}</td>
                            <td>
                                <select class="role-select" data-user-id="${userId}" onchange="updateUserRole('${userId}', this.value)">
                                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</option>
                                    <option value="redactor" ${user.role === 'redactor' ? 'selected' : ''}>–†–µ–¥–∞–∫—Ç–æ—Ä</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>–ê–¥–º–∏–Ω</option>
                                </select>
                            </td>
                            <td>
                                <span title="–ò–∑–ø—Ä–∞—Ç–µ–Ω–∏">üì§ ${user.articlesSubmitted || 0}</span> |
                                <span title="–ü—É–±–ª–∏–∫—É–≤–∞–Ω–∏">üì∞ ${user.articlesPublished || 0}</span>
                            </td>
                            <td>${registerDate}</td>
                            <td>
                                <button onclick="deleteUser('${userId}')" class="btn-small btn-danger">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                </div>`;
                
                usersContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersContainer').innerHTML = '<p>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏—Ç–µ.</p>';
            }
        }

        // ========== ARTICLE QUEUE FUNCTIONS - SINGLE VERSION ==========
        async function loadArticleQueue() {
            try {
                console.log('üîÑ Loading admin queue...');
                const articlesContainer = document.getElementById('adminQueueContainer');
                
                // Try admin queue first
                const queueSnapshot = await firebase.database().ref('queues/adminQueue').once('value');
                
                if (queueSnapshot.exists()) {
                    console.log('üìã Found in admin queue:', Object.keys(queueSnapshot.val()));
                    
                    let html = '';
                    let loadedCount = 0;
                    
                    // Load each article
                    for (const articleId in queueSnapshot.val()) {
                        const articleSnapshot = await firebase.database().ref(`articles/${articleId}`).once('value');
                        
                        if (articleSnapshot.exists()) {
                            const article = articleSnapshot.val();
                            
                            if (article.status === 'approved') {
                                loadedCount++;
                                const queueData = queueSnapshot.val()[articleId];
                                
                                html += `
                                    <div class="admin-queue-item" id="queue-item-${articleId}">
                                        <h3>${article.title || '–ë–µ–∑ –∑–∞–≥–ª–∞–≤–∏–µ'}</h3>
                                        <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${article.author || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                                        <p><strong>–†–µ–¥–∞–∫—Ç–æ—Ä:</strong> ${queueData.redactorName || article.redactorId || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                                        <p><strong>–î–∞—Ç–∞:</strong> ${new Date(article.approvedAt || article.date).toLocaleDateString('bg-BG')}</p>
                                        ${article.redactorNotes ? `<p><strong>–ë–µ–ª–µ–∂–∫–∏:</strong> ${article.redactorNotes}</p>` : ''}
                                        <div class="queue-actions">
                                            <button onclick="previewArticle('${articleId}')" class="btn-small">üëÅÔ∏è –ü—Ä–µ–≥–ª–µ–¥</button>
                                            <button onclick="publishArticle('${articleId}')" class="btn-small btn-success">‚úÖ –ü—É–±–ª–∏–∫—É–≤–∞–π</button>
                                            <button onclick="returnToRedactor('${articleId}')" class="btn-small btn-warning">‚Ü©Ô∏è –í—ä—Ä–Ω–∏ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
                                        </div>
                                    </div>
                                `;
                            }
                        } else {
                            // Remove orphaned entry
                            await firebase.database().ref(`queues/adminQueue/${articleId}`).remove();
                        }
                    }
                    
                    if (loadedCount > 0) {
                        articlesContainer.innerHTML = html;
                        console.log(`‚úÖ Loaded ${loadedCount} articles from queue`);
                        return;
                    }
                }
                
                console.log('üì≠ Admin queue empty - checking approved articles');
                
                // Fallback to approved articles
                const approvedSnapshot = await firebase.database().ref('articles')
                    .orderByChild('status')
                    .equalTo('approved')
                    .once('value');
                
                if (!approvedSnapshot.exists()) {
                    articlesContainer.innerHTML = 
                        '<div class="empty-state">–ù—è–º–∞ —Å—Ç–∞—Ç–∏–∏, —á–∞–∫–∞—â–∏ –æ–∫–æ–Ω—á–∞—Ç–µ–ª–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∏–µ.</div>';
                    return;
                }
                
                let html = '';
                let count = 0;
                
                approvedSnapshot.forEach(child => {
                    const article = child.val();
                    const articleId = child.key;
                    count++;
                    
                    html += `
                        <div class="admin-queue-item" id="queue-item-${articleId}">
                            <div style="background: #ffeaa7; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                ‚ö†Ô∏è <strong>–°—Ç–∞—Ç–∏—è—Ç–∞ –µ –æ–¥–æ–±—Ä–µ–Ω–∞, –Ω–æ –Ω–µ –µ –≤ –æ–ø–∞—à–∫–∞—Ç–∞!</strong>
                                <button onclick="addToQueue('${articleId}')" style="margin-left: 10px; padding: 3px 8px; font-size: 12px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                    –î–æ–±–∞–≤–∏ –≤ –æ–ø–∞—à–∫–∞
                                </button>
                            </div>
                            <h3>${article.title || '–ë–µ–∑ –∑–∞–≥–ª–∞–≤–∏–µ'}</h3>
                            <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${article.author || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                            <p><strong>–†–µ–¥–∞–∫—Ç–æ—Ä:</strong> ${article.redactorId || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                            <p><strong>–û–¥–æ–±—Ä–µ–Ω–∞:</strong> ${new Date(article.approvedAt || article.date).toLocaleDateString('bg-BG')}</p>
                            ${article.redactorNotes ? `<p><strong>–ë–µ–ª–µ–∂–∫–∏:</strong> ${article.redactorNotes}</p>` : ''}
                            <div class="queue-actions">
                                <button onclick="previewArticle('${articleId}')" class="btn-small">üëÅÔ∏è –ü—Ä–µ–≥–ª–µ–¥</button>
                                <button onclick="publishArticle('${articleId}')" class="btn-small btn-success">‚úÖ –ü—É–±–ª–∏–∫—É–≤–∞–π</button>
                                <button onclick="returnToRedactor('${articleId}')" class="btn-small btn-warning">‚Ü©Ô∏è –í—ä—Ä–Ω–∏ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
                            </div>
                        </div>
                    `;
                });
                
                articlesContainer.innerHTML = html;
                console.log(`‚úÖ Loaded ${count} approved articles directly`);
                
            } catch (error) {
                console.error('‚ùå Error loading articles:', error);
                document.getElementById('adminQueueContainer').innerHTML = 
                    '<div class="empty-state">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ. –ú–æ–ª—è, –æ–ø—Ä–µ—Å–Ω–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.</div>';
            }
        }

        // ========== HELPER FUNCTIONS ==========
        async function updateUserRole(userId, newRole) {
            if (!confirm(`–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ —Ä–æ–ª—è—Ç–∞ –Ω–∞ —Ç–æ–∑–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª –Ω–∞ "${newRole}"?`)) {
                return;
            }
            
            try {
                await db.ref(`users/${userId}`).update({
                    role: newRole,
                    roleUpdatedAt: firebase.database.ServerValue.TIMESTAMP,
                    roleUpdatedBy: auth.currentUser.uid
                });
                
                alert(`‚úÖ –†–æ–ª—è—Ç–∞ –µ –ø—Ä–æ–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –Ω–∞ "${newRole}"!`);
                loadUserManagement();
            } catch (error) {
                console.error('Error updating user role:', error);
                alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—Ä–æ–º—è–Ω–∞ –Ω–∞ —Ä–æ–ª—è—Ç–∞: ' + error.message);
            }
        }

        async function addToQueue(articleId) {
            if (!confirm('–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞ –≤ –æ–ø–∞—à–∫–∞—Ç–∞ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ?')) return;
            
            try {
                const articleSnap = await firebase.database().ref(`articles/${articleId}`).once('value');
                const article = articleSnap.val();
                
                if (!article) {
                    alert('–°—Ç–∞—Ç–∏—è—Ç–∞ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞!');
                    return;
                }
                
                await firebase.database().ref(`queues/adminQueue/${articleId}`).set({
                    articleId: articleId,
                    redactorId: article.redactorId,
                    redactorName: article.redactorName,
                    approvedAt: article.approvedAt || Date.now(),
                    title: article.title,
                    author: article.author,
                    addedToQueue: firebase.database.ServerValue.TIMESTAMP
                });
                
                alert('‚úÖ –°—Ç–∞—Ç–∏—è—Ç–∞ –µ –¥–æ–±–∞–≤–µ–Ω–∞ –≤ –æ–ø–∞—à–∫–∞—Ç–∞ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ!');
                loadArticleQueue();
            } catch (error) {
                alert('‚ùå –ì—Ä–µ—à–∫–∞: ' + error.message);
            }
        }

        async function publishArticle(articleId) {
            if (!confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –ø—É–±–ª–∏–∫—É–≤–∞—Ç–µ —Ç–∞–∑–∏ —Å—Ç–∞—Ç–∏—è?')) return;
            
            try {
                console.log(`üöÄ Publishing article: ${articleId}`);
                
                const articleSnapshot = await firebase.database().ref(`articles/${articleId}`).once('value');
                const article = articleSnapshot.val();
                
                if (!article) {
                    alert('‚ùå –°—Ç–∞—Ç–∏—è—Ç–∞ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞!');
                    return;
                }
                
                const updates = {
                    status: 'published',
                    publishedAt: firebase.database.ServerValue.TIMESTAMP,
                    publishedBy: auth.currentUser.uid,
                    publishedByName: auth.currentUser.displayName || auth.currentUser.email,
                    isLive: true,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                };
                
                await firebase.database().ref(`articles/${articleId}`).update(updates);
                
                await firebase.database().ref(`queues/adminQueue/${articleId}`).remove()
                    .catch(err => console.log('Queue removal error:', err));
                
                if (article.authorId) {
                    try {
                        const authorRef = firebase.database().ref(`users/${article.authorId}`);
                        const authorSnapshot = await authorRef.once('value');
                        const authorData = authorSnapshot.val() || {};
                        
                        await authorRef.update({
                            articlesPublished: (authorData.articlesPublished || 0) + 1,
                            lastPublished: firebase.database.ServerValue.TIMESTAMP
                        });
                    } catch (authorError) {
                        console.error('Error updating author count:', authorError);
                    }
                }
                
                const queueItem = document.getElementById(`queue-item-${articleId}`);
                if (queueItem) {
                    queueItem.style.opacity = '0.5';
                    queueItem.innerHTML = '<div style="padding: 20px; text-align: center; color: green;">‚úÖ –ü—É–±–ª–∏–∫—É–≤–∞–Ω–∞!</div>';
                    setTimeout(() => queueItem.remove(), 2000);
                }
                
                alert('‚úÖ –°—Ç–∞—Ç–∏—è—Ç–∞ –µ –ø—É–±–ª–∏–∫—É–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                
                setTimeout(() => {
                    loadArticleQueue();
                }, 2500);
                
            } catch (error) {
                console.error('‚ùå Error publishing article:', error);
                alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫—É–≤–∞–Ω–µ: ' + error.message);
            }
        }

        async function returnToRedactor(articleId) {
            const reason = prompt('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –ø—Ä–∏—á–∏–Ω–∞ –∑–∞ –≤—Ä—ä—â–∞–Ω–µ—Ç–æ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞:');
            if (!reason) return;
            
            try {
                await firebase.database().ref(`articles/${articleId}`).update({
                    status: 'needs_revision',
                    adminFeedback: reason,
                    returnedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                await firebase.database().ref(`queues/adminQueue/${articleId}`).remove();
                
                alert('‚úÖ –°—Ç–∞—Ç–∏—è—Ç–∞ –µ –≤—ä—Ä–Ω–∞—Ç–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∑–∞ –ø—Ä–µ—Ä–∞–±–æ—Ç–∫–∞!');
                loadArticleQueue();
                
            } catch (error) {
                console.error('Error returning article:', error);
                alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ä—ä—â–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞: ' + error.message);
            }
        }

        function previewArticle(articleId) {
            window.open(`article.html?id=${articleId}`, '_blank');
        }

        async function deleteUser(userId) {
            if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï: –°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–∑–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª?\n\n–¢–æ–≤–∞ –¥–µ–π—Å—Ç–≤–∏–µ –µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ –∏ —â–µ –∏–∑—Ç—Ä–∏–µ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è.')) {
                return;
            }
            
            try {
                await firebase.database().ref(`users/${userId}`).remove();
                
                alert('‚úÖ –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –∏–∑—Ç—Ä–∏—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∞!');
                loadUserManagement();
                
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è: ' + error.message);
            }
        }

        // ========== DEBUG FUNCTIONS ==========
        async function debugAdminQueue() {
            console.log('=== ADMIN QUEUE DEBUG ===');
            
            try {
                const queue = await firebase.database().ref('queues/adminQueue').once('value');
                console.log('üìã Admin queue:', queue.exists() ? Object.keys(queue.val()) : 'EMPTY');
                
                const approved = await firebase.database().ref('articles')
                    .orderByChild('status')
                    .equalTo('approved')
                    .once('value');
                console.log('‚úÖ Approved articles:', approved.exists() ? approved.numChildren() : 0);
                
                if (approved.exists()) {
                    approved.forEach(child => {
                        console.log(`- ${child.key}: "${child.val().title}"`);
                    });
                }
                
            } catch (error) {
                console.error('Debug error:', error);
            }
        }

        async function fixQueueIssues() {
            if (!confirm('–¢–æ–≤–∞ —â–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞ –æ–ø–∞—à–∫–∞—Ç–∞ —Å—ä—Å —Å—Ç–∞—Ç—É—Å–∏—Ç–µ. –ü—Ä–æ–¥—ä–ª–∂–∞–≤–∞–Ω–µ?')) return;
            
            try {
                const snapshot = await firebase.database().ref('articles')
                    .orderByChild('status')
                    .equalTo('approved')
                    .once('value');
                
                if (!snapshot.exists()) {
                    alert('–ù—è–º–∞ –æ–¥–æ–±—Ä–µ–Ω–∏ —Å—Ç–∞—Ç–∏–∏!');
                    return;
                }
                
                let fixed = 0;
                
                snapshot.forEach(async child => {
                    const articleId = child.key;
                    
                    const inQueue = await firebase.database().ref(`queues/adminQueue/${articleId}`).once('value');
                    
                    if (!inQueue.exists()) {
                        await firebase.database().ref(`queues/adminQueue/${articleId}`).set({
                            articleId: articleId,
                            addedAt: firebase.database.ServerValue.TIMESTAMP,
                            autoAdded: true
                        });
                        fixed++;
                        console.log(`Added ${articleId} to queue`);
                    }
                });
                
                alert(`‚úÖ –ü–æ–ø—Ä–∞–≤–µ–Ω–∏ ${fixed} —Å—Ç–∞—Ç–∏–∏ –≤ –æ–ø–∞—à–∫–∞—Ç–∞!`);
                loadArticleQueue();
                
            } catch (error) {
                alert('‚ùå –ì—Ä–µ—à–∫–∞: ' + error.message);
            }
        }
    </script>
</body>
</html>