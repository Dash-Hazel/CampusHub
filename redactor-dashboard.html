

<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –ü–∞–Ω–µ–ª - –ú–ª–∞–¥ –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        body { padding-top: 100px; background: #f5f7fa; }
        .redactor-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .dashboard-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .queue-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .queue-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .queue-count {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .article-card {
            background: white;
            border: 1px solid #eaeaea;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
        }
        
        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .article-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-submitted { background: #ffeaa7; color: #d35400; }
        .status-under_review { background: #a29bfe; color: white; }
        .status-approved { background: #55efc4; color: #00b894; }
        
        .article-meta {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            color: #666;
            font-size: 14px;
        }
        
        .article-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-claim, .btn-review, .btn-decline {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-claim { background: #3498db; color: white; }
        .btn-review { background: #2ecc71; color: white; }
        .btn-decline { background: #e74c3c; color: white; }
        
        .btn-claim:hover, .btn-review:hover, .btn-decline:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        .empty-queue {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }
        
        .empty-queue-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* Review Modal */
        .review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #3498db;
            font-weight: bold;
            color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .original-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .edit-area {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
        }
        
        .notes-area {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            margin-top: 20px;
            resize: vertical;
        }
        
        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>–ú–ª–∞–¥ –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç</h1>
                <p>–†–µ–¥–∞–∫—Ç–æ—Ä—Å–∫–∏ –ø–∞–Ω–µ–ª</p>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">‚Üê –ù–∞–∑–∞–¥ –∫—ä–º —Å–∞–π—Ç–∞</a></li>
                    <li><a href="#" id="logoutBtn">üö™ –ò–∑—Ö–æ–¥</a></li>
                </ul>
            </nav>
        </div>  
    </header>

    <div class="redactor-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1>üìã –†–µ–¥–∞–∫—Ç–æ—Ä—Å–∫–∏ –ø–∞–Ω–µ–ª</h1>
            <p>–ü—Ä–µ–≥–ª–µ–∂–¥–∞–Ω–µ –∏ —Ä–µ–¥–∞–∫—Ü–∏—è –Ω–∞ –ø–æ–¥–∞–¥–µ–Ω–∏ —Å—Ç–∞—Ç–∏–∏</p>
            
            <div class="statistics">
                <div class="stat-card">
                    <div class="stat-label">–ß–∞–∫–∞—â–∏ –ø—Ä–µ–≥–ª–µ–¥</div>
                    <div class="stat-number" id="pendingCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–í –ø—Ä–æ—Ü–µ—Å –Ω–∞ —Ä–µ–¥–∞–∫—Ü–∏—è</div>
                    <div class="stat-number" id="inReviewCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–û–¥–æ–±—Ä–µ–Ω–∏ –¥–Ω–µ—Å</div>
                    <div class="stat-number" id="approvedToday">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–û–±—â–æ –æ–¥–æ–±—Ä–µ–Ω–∏</div>
                    <div class="stat-number" id="totalApproved">0</div>
                </div>
            </div>
        </div>

        <!-- Submitted Articles Queue -->
        <div class="queue-section">
            <div class="queue-title">
                <h2>üì• –ß–∞–∫–∞—â–∏ —Å—Ç–∞—Ç–∏–∏ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥</h2>
                <span class="queue-count" id="submittedCount">0</span>
            </div>
            
            <div id="submittedArticles" class="articles-grid">
                <!-- Submitted articles will load here -->
                <div class="empty-queue">
                    <div class="empty-queue-icon">üì≠</div>
                    <h3>–ù—è–º–∞ —á–∞–∫–∞—â–∏ —Å—Ç–∞—Ç–∏–∏</h3>
                    <p>–í –º–æ–º–µ–Ω—Ç–∞ –Ω—è–º–∞ –Ω–æ–≤–æ–ø–æ—Å—Ç—ä–ø–∏–ª–∏ —Å—Ç–∞—Ç–∏–∏ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥.</p>
                </div>
            </div>
        </div>

        <!-- Articles Under My Review -->
        <div class="queue-section">
            <div class="queue-title">
                <h2>‚úèÔ∏è –°—Ç–∞—Ç–∏–∏ –≤ –ø—Ä–æ—Ü–µ—Å –Ω–∞ —Ä–µ–¥–∞–∫—Ü–∏—è</h2>
                <span class="queue-count" id="myReviewCount">0</span>
            </div>
            
            <div id="myReviewArticles" class="articles-grid">
                <!-- Articles under review will load here -->
                <div class="empty-queue">
                    <div class="empty-queue-icon">üìù</div>
                    <h3>–ù—è–º–∞ —Å—Ç–∞—Ç–∏–∏ –≤ —Ä–µ–¥–∞–∫—Ü–∏—è</h3>
                    <p>–ó–∞–ø–æ—á–Ω–µ—Ç–µ –¥–∞ –ø—Ä–µ–≥–ª–µ–∂–¥–∞—Ç–µ —Å—Ç–∞—Ç–∏–∏ –æ—Ç –≥–æ—Ä–Ω–∏—è —Å–ø–∏—Å—ä–∫.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="review-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">–†–µ–¥–∞–∫—Ü–∏—è –Ω–∞ —Å—Ç–∞—Ç–∏—è</h2>
                <button class="close-modal" id="closeModalBtn">√ó</button>
            </div>
            
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ü–∏—è</div>
                    <div class="tab" data-tab="history">üìã –ò—Å—Ç–æ—Ä–∏—è</div>
                </div>
                
                <!-- Edit Tab -->
                <div id="editTab" class="tab-content active">
                    <div class="original-content">
                        <h4>–û—Ä–∏–≥–∏–Ω–∞–ª–µ–Ω —Ç–µ–∫—Å—Ç:</h4>
                        <p id="originalContent"></p>
                    </div>
                    
                    <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω —Ç–µ–∫—Å—Ç:</h4>
                    <textarea id="editedContent" class="edit-area" placeholder="–ù–∞–ø—Ä–∞–≤–µ—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏—Ç–µ —Ä–µ–¥–∞–∫—Ü–∏–∏ —Ç—É–∫..."></textarea>
                    
                    <h4>–ë–µ–ª–µ–∂–∫–∏ –∑–∞ –∞–≤—Ç–æ—Ä–∞/–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</h4>
                    <textarea id="editorNotes" class="notes-area" placeholder="–û–±—è—Å–Ω–µ—Ç–µ –Ω–∞–ø—Ä–∞–≤–µ–Ω–∏—Ç–µ –ø—Ä–æ–º–µ–Ω–∏ –∏–ª–∏ –¥–∞–π—Ç–µ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏..."></textarea>
                </div>
                
                <!-- History Tab -->
                <div id="historyTab" class="tab-content">
                    <div id="articleHistory">
                        <!-- History will be loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="saveDraftBtn" class="btn-claim">üíæ –ó–∞–ø–∞–∑–∏ —á–µ—Ä–Ω–æ–≤–∞</button>
                <button id="sendToAdminBtn" class="btn-review">‚úÖ –û–¥–æ–±—Ä–∏ –∏ –∏–∑–ø—Ä–∞—Ç–∏ –Ω–∞ –∞–¥–º–∏–Ω</button>
                <button id="declineArticleBtn" class="btn-decline">‚ùå –í—ä—Ä–Ω–∏ –∑–∞ –ø—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</button>
            </div>
        </div>
    </div>


    <script>
        // Redactor Dashboard JavaScript
        let currentUser = null;
        let currentArticleId = null;
        
        // Check authentication
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await checkUserRole(user.uid);
                loadArticles();
            } else {
                // Redirect to login
                window.location.href = 'index.html';
            }
        });
        
        // Check if user is redactor
        async function checkUserRole(uid) {
            const snapshot = await firebase.database().ref(`users/${uid}/role`).once('value');
            const role = snapshot.val();
            
            if (role !== 'redactor' && role !== 'admin') {
                alert('–ù—è–º–∞—Ç–µ –¥–æ—Å—Ç—ä–ø –¥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä—Å–∫–∏—è –ø–∞–Ω–µ–ª!');
                window.location.href = 'index.html';
            }
        }
        
        // Load articles for redactor
        function loadArticles() {
            // Load submitted articles (status: submitted)
            firebase.database().ref('articles')
                .orderByChild('status')
                .equalTo('submitted')
                .once('value')
                .then(snapshot => {
                    displaySubmittedArticles(snapshot);
                    updateStatistics();
                });
            
            // Load articles under current redactor's review
            firebase.database().ref('articles')
                .orderByChild('redactorId')
                .equalTo(currentUser.uid)
                .once('value')
                .then(snapshot => {
                    displayMyReviewArticles(snapshot);
                });
        }
        
        // Display submitted articles
        function displaySubmittedArticles(snapshot) {
            const container = document.getElementById('submittedArticles');
            const countElement = document.getElementById('submittedCount');
            
            if (!snapshot.exists()) {
                container.innerHTML = `
                    <div class="empty-queue">
                        <div class="empty-queue-icon">üì≠</div>
                        <h3>–ù—è–º–∞ —á–∞–∫–∞—â–∏ —Å—Ç–∞—Ç–∏–∏</h3>
                        <p>–í –º–æ–º–µ–Ω—Ç–∞ –Ω—è–º–∞ –Ω–æ–≤–æ–ø–æ—Å—Ç—ä–ø–∏–ª–∏ —Å—Ç–∞—Ç–∏–∏ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥.</p>
                    </div>
                `;
                countElement.textContent = '0';
                return;
            }
            
            let html = '';
            let count = 0;
            
            snapshot.forEach(childSnapshot => {
                const article = childSnapshot.val();
                const articleId = childSnapshot.key;
                
                // Only show articles with status 'submitted'
                if (article.status === 'submitted') {
                    count++;
                    const date = new Date(article.submittedAt || article.date).toLocaleDateString('bg-BG');
                    
                    html += `
                        <div class="article-card" data-id="${articleId}">
                            <span class="article-status status-submitted">–ß–∞–∫–∞—â</span>
                            <h3>${article.title}</h3>
                            <p class="article-excerpt">${article.excerpt || '–ù—è–º–∞ –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ'}</p>
                            <div class="article-meta">
                                <span>‚úçÔ∏è ${article.author}</span>
                                <span>üìÖ ${date}</span>
                            </div>
                            <div class="article-actions">
                                <button class="btn-claim" onclick="claimArticle('${articleId}')">üìã –ó–∞—è–≤–∏ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥</button>
                                <button class="btn-review" onclick="startReview('${articleId}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
            countElement.textContent = count;
        }
        
        // Display articles under my review
        function displayMyReviewArticles(snapshot) {
            const container = document.getElementById('myReviewArticles');
            const countElement = document.getElementById('myReviewCount');
            
            if (!snapshot.exists()) {
                container.innerHTML = `
                    <div class="empty-queue">
                        <div class="empty-queue-icon">üìù</div>
                        <h3>–ù—è–º–∞ —Å—Ç–∞—Ç–∏–∏ –≤ —Ä–µ–¥–∞–∫—Ü–∏—è</h3>
                        <p>–ó–∞–ø–æ—á–Ω–µ—Ç–µ –¥–∞ –ø—Ä–µ–≥–ª–µ–∂–¥–∞—Ç–µ —Å—Ç–∞—Ç–∏–∏ –æ—Ç –≥–æ—Ä–Ω–∏—è —Å–ø–∏—Å—ä–∫.</p>
                    </div>
                `;
                countElement.textContent = '0';
                return;
            }
            
            let html = '';
            let count = 0;
            
            snapshot.forEach(childSnapshot => {
                const article = childSnapshot.val();
                const articleId = childSnapshot.key;
                
                // Only show articles with status 'under_review' or 'needs_revision'
                if (article.status === 'under_review' || article.status === 'needs_revision') {
                    count++;
                    const date = new Date(article.claimedAt || article.date).toLocaleDateString('bg-BG');
                    const statusClass = article.status === 'under_review' ? 'status-under_review' : 'status-submitted';
                    const statusText = article.status === 'under_review' ? '–í —Ä–µ–¥–∞–∫—Ü–∏—è' : '–¢—Ä—è–±–≤–∞ –ø—Ä–µ—Ä–∞–±–æ—Ç–∫–∞';
                    
                    html += `
                        <div class="article-card" data-id="${articleId}">
                            <span class="article-status ${statusClass}">${statusText}</span>
                            <h3>${article.title}</h3>
                            <p class="article-excerpt">${article.excerpt || '–ù—è–º–∞ –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ'}</p>
                            <div class="article-meta">
                                <span>‚úçÔ∏è ${article.author}</span>
                                <span>üìÖ ${date}</span>
                                ${article.deadline ? `<span>‚è∞ –ö—Ä–∞–µ–Ω —Å—Ä–æ–∫: ${new Date(article.deadline).toLocaleDateString('bg-BG')}</span>` : ''}
                            </div>
                            <div class="article-actions">
                                <button class="btn-review" onclick="startReview('${articleId}')">‚úèÔ∏è –ü—Ä–æ–¥—ä–ª–∂–∏ —Ä–µ–¥–∞–∫—Ü–∏—è</button>
                                <button class="btn-decline" onclick="returnToAuthor('${articleId}')">‚Ü©Ô∏è –í—ä—Ä–Ω–∏ –Ω–∞ –∞–≤—Ç–æ—Ä–∞</button>
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
            countElement.textContent = count;
        }
        
        // Update statistics
        function updateStatistics() {
            const today = new Date().setHours(0,0,0,0);
            
            // Count pending articles
            firebase.database().ref('articles')
                .orderByChild('status')
                .equalTo('submitted')
                .once('value')
                .then(snapshot => {
                    document.getElementById('pendingCount').textContent = snapshot.exists() ? snapshot.numChildren() : 0;
                });
            
            // Count articles in review by current user
            firebase.database().ref('articles')
                .orderByChild('redactorId')
                .equalTo(currentUser.uid)
                .once('value')
                .then(snapshot => {
                    let inReviewCount = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            if (child.val().status === 'under_review') {
                                inReviewCount++;
                            }
                        });
                    }
                    document.getElementById('inReviewCount').textContent = inReviewCount;
                });
            
            // Count articles approved today by current user
            firebase.database().ref('articles')
                .orderByChild('redactorId')
                .equalTo(currentUser.uid)
                .once('value')
                .then(snapshot => {
                    let approvedToday = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const article = child.val();
                            if (article.status === 'approved') {
                                const approvedDate = new Date(article.approvedAt || article.date);
                                if (approvedDate.setHours(0,0,0,0) === today) {
                                    approvedToday++;
                                }
                            }
                        });
                    }
                    document.getElementById('approvedToday').textContent = approvedToday;
                });
            
            // Count total approved by current user
            firebase.database().ref('articles')
                .orderByChild('redactorId')
                .equalTo(currentUser.uid)
                .once('value')
                .then(snapshot => {
                    let totalApproved = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            if (child.val().status === 'approved') {
                                totalApproved++;
                            }
                        });
                    }
                    document.getElementById('totalApproved').textContent = totalApproved;
                });
        }
        
        // Claim article for review
        function claimArticle(articleId) {
            if (confirm('–ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –∑–∞—è–≤–∏—Ç–µ —Ç–∞–∑–∏ —Å—Ç–∞—Ç–∏—è –∑–∞ –ø—Ä–µ–≥–ª–µ–¥?')) {
                firebase.database().ref(`articles/${articleId}`).update({
                    status: 'under_review',
                    redactorId: currentUser.uid,
                    claimedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    alert('‚úÖ –°—Ç–∞—Ç–∏—è—Ç–∞ –µ –∑–∞—è–≤–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥!');
                    loadArticles();
                })
                .catch(error => {
                    alert('‚ùå –ì—Ä–µ—à–∫–∞: ' + error.message);
                });
            }
        }
        
        // Start reviewing an article
        let currentReviewArticle = null;
        
        function startReview(articleId) {
            currentArticleId = articleId;
            
            firebase.database().ref(`articles/${articleId}`).once('value')
                .then(snapshot => {
                    currentReviewArticle = snapshot.val();
                    
                    // Update modal
                    document.getElementById('modalTitle').textContent = `–†–µ–¥–∞–∫—Ü–∏—è: ${currentReviewArticle.title}`;
                    document.getElementById('originalContent').textContent = currentReviewArticle.content || currentReviewArticle.excerpt;
                    document.getElementById('editedContent').value = currentReviewArticle.content || currentReviewArticle.excerpt;
                    document.getElementById('editorNotes').value = currentReviewArticle.redactorNotes || '';
                    
                    // Load history
                    loadArticleHistory(articleId);
                    
                    // Show modal
                    document.getElementById('reviewModal').style.display = 'flex';
                    
                    // Switch to edit tab
                    switchTab('edit');
                });
        }
        
        // Load article history
        function loadArticleHistory(articleId) {
            firebase.database().ref(`articles/${articleId}/history`).once('value')
                .then(snapshot => {
                    const historyContainer = document.getElementById('articleHistory');
                    
                    if (!snapshot.exists()) {
                        historyContainer.innerHTML = '<p>–ù—è–º–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–µ–¥–∞–∫—Ü–∏–∏.</p>';
                        return;
                    }
                    
                    let historyHTML = '<div class="history-list">';
                    snapshot.forEach(childSnapshot => {
                        const version = childSnapshot.key;
                        const data = childSnapshot.val();
                        
                        historyHTML += `
                            <div class="history-item">
                                <div class="history-header">
                                    <strong>–í–µ—Ä—Å–∏—è: ${version}</strong>
                                    <span>${new Date(data.timestamp).toLocaleString('bg-BG')}</span>
                                </div>
                                <p><strong>–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–æ –æ—Ç:</strong> ${data.editedBy || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                                ${data.notes ? `<p><strong>–ë–µ–ª–µ–∂–∫–∏:</strong> ${data.notes}</p>` : ''}
                                <div class="history-content">
                                    ${data.content ? `<p>${data.content.substring(0, 200)}...</p>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    historyHTML += '</div>';
                    
                    historyContainer.innerHTML = historyHTML;
                });
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabName + 'Tab');
            });
        }
        
        // Save draft
        document.getElementById('saveDraftBtn').addEventListener('click', () => {
            const editedContent = document.getElementById('editedContent').value;
            const notes = document.getElementById('editorNotes').value;
            
            const updates = {
                content: editedContent,
                redactorNotes: notes,
                lastEdited: firebase.database.ServerValue.TIMESTAMP,
                lastEditedBy: currentUser.uid
            };
            
            // Save to history
            const historyKey = `version_${Date.now()}`;
            updates[`history/${historyKey}`] = {
                content: editedContent,
                editedBy: currentUser.uid,
                notes: notes,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            firebase.database().ref(`articles/${currentArticleId}`).update(updates)
                .then(() => {
                    alert('‚úÖ –ß–µ—Ä–Ω–æ–≤–∞—Ç–∞ –µ –∑–∞–ø–∞–∑–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                })
                .catch(error => {
                    alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ: ' + error.message);
                });
        });
        
       // ========== FIXED: Send to admin ==========
document.getElementById('sendToAdminBtn').addEventListener('click', async () => {
    if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –æ–¥–æ–±—Ä–∏—Ç–µ –∏ –∏–∑–ø—Ä–∞—Ç–∏—Ç–µ —Ç–∞–∑–∏ —Å—Ç–∞—Ç–∏—è –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?')) {
        const editedContent = document.getElementById('editedContent').value;
        const notes = document.getElementById('editorNotes').value;
        
        // Get database reference
        const db = firebase.database();
        
        try {
            console.log('üöÄ Starting approval for article:', currentArticleId);
            
            // STEP 1: Update article status to approved
            const articleUpdates = {
                status: 'approved',
                content: editedContent,
                redactorNotes: notes,
                approvedAt: firebase.database.ServerValue.TIMESTAMP,
                approvedBy: currentUser.uid,
                approvedByName: currentUser.displayName || currentUser.email,
                lastEdited: firebase.database.ServerValue.TIMESTAMP,
                queueStatus: 'in_admin_queue'
            };
            
            console.log('Step 1: Updating article to approved...');
            await db.ref(`articles/${currentArticleId}`).update(articleUpdates);
            console.log('‚úÖ Article updated to approved');
            
            // STEP 2: Add to admin queue
            const queueData = {
                articleId: currentArticleId,
                redactorId: currentUser.uid,
                redactorName: currentUser.displayName || currentUser.email,
                redactorEmail: currentUser.email,
                approvedAt: firebase.database.ServerValue.TIMESTAMP,
                title: currentReviewArticle.title,
                author: currentReviewArticle.author,
                excerpt: currentReviewArticle.excerpt || editedContent.substring(0, 200) + '...',
                category: currentReviewArticle.category || 'general',
                timestamp: Date.now(),
                addedToQueueAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            console.log('Step 2: Adding to admin queue...');
            await db.ref(`queues/adminQueue/${currentArticleId}`).set(queueData);
            console.log('‚úÖ Added to admin queue');
            
            // STEP 3: Clear redactor assignment
            console.log('Step 3: Clearing redactor assignment...');
            await db.ref(`articles/${currentArticleId}`).update({
                redactorId: null,
                claimedAt: null
            });
            console.log('‚úÖ Redactor assignment cleared');
            
            // Success
            alert('‚úÖ –°—Ç–∞—Ç–∏—è—Ç–∞ –µ –æ–¥–æ–±—Ä–µ–Ω–∞ –∏ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞ –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!');
            document.getElementById('reviewModal').style.display = 'none';
            loadArticles();
            
            // Verify success
            setTimeout(async () => {
                const statusCheck = await db.ref(`articles/${currentArticleId}/status`).once('value');
                const queueCheck = await db.ref(`queues/adminQueue/${currentArticleId}`).once('value');
                
                console.log('üîç Verification:');
                console.log('- Article status:', statusCheck.val());
                console.log('- In admin queue:', queueCheck.exists());
                
                if (statusCheck.val() === 'approved' && queueCheck.exists()) {
                    console.log('üéâ SUCCESS: Article properly sent to admin!');
                } else {
                    console.error('‚ùå ERROR: Something went wrong!');
                }
            }, 1000);
            
        } catch (error) {
            console.error('‚ùå CRITICAL ERROR:', error);
            alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–µ: ' + error.message);
        }
    }
});
        
        // Decline/return to author
        document.getElementById('declineArticleBtn').addEventListener('click', () => {
            const reason = prompt('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –ø—Ä–∏—á–∏–Ω–∞ –∑–∞ –≤—Ä—ä—â–∞–Ω–µ—Ç–æ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞:');
            if (reason) {
                const updates = {
                    status: 'declined',
                    declineReason: reason,
                    declinedAt: firebase.database.ServerValue.TIMESTAMP,
                    needsRevision: true
                };
                
                firebase.database().ref(`articles/${currentArticleId}`).update(updates)
                    .then(() => {
                        alert('‚úÖ –°—Ç–∞—Ç–∏—è—Ç–∞ –µ –≤—ä—Ä–Ω–∞—Ç–∞ –Ω–∞ –∞–≤—Ç–æ—Ä–∞ –∑–∞ –ø—Ä–µ—Ä–∞–±–æ—Ç–∫–∞!');
                        document.getElementById('reviewModal').style.display = 'none';
                        loadArticles();
                    })
                    .catch(error => {
                        alert('‚ùå –ì—Ä–µ—à–∫–∞: ' + error.message);
                    });
            }
        });
        
        // Return to author (from my review list)
        function returnToAuthor(articleId) {
            const reason = prompt('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –ø—Ä–∏—á–∏–Ω–∞ –∑–∞ –≤—Ä—ä—â–∞–Ω–µ—Ç–æ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞:');
            if (reason) {
                firebase.database().ref(`articles/${articleId}`).update({
                    status: 'declined',
                    declineReason: reason,
                    declinedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    alert('‚úÖ –°—Ç–∞—Ç–∏—è—Ç–∞ –µ –≤—ä—Ä–Ω–∞—Ç–∞ –Ω–∞ –∞–≤—Ç–æ—Ä–∞!');
                    loadArticles();
                })
                .catch(error => {
                    alert('‚ùå –ì—Ä–µ—à–∫–∞: ' + error.message);
                });
            }
        }
        
        // Close modal
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('reviewModal').style.display = 'none';
        });
        
        // Tab click handlers
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchTab(tab.dataset.tab);
            });
        });
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            firebase.auth().signOut()
                .then(() => {
                    window.location.href = 'index.html';
                });
        });
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (currentUser) {
                loadArticles();
            }
        }, 30000);


        // Helper: Load approved articles directly
async function loadApprovedArticlesDirectly() {
    console.log('üîÑ Loading approved articles directly...');
    
    try {
        const snapshot = await firebase.database().ref('articles')
            .orderByChild('status')
            .equalTo('approved')
            .once('value');
        
        const articlesContainer = document.getElementById('adminQueueContainer');
        
        if (!snapshot.exists()) {
            articlesContainer.innerHTML = 
                '<div class="empty-state">–ù—è–º–∞ —Å—Ç–∞—Ç–∏–∏ —Å –æ–¥–æ–±—Ä–µ–Ω —Å—Ç–∞—Ç—É—Å.</div>';
            return;
        }
        
        let html = '';
        let count = 0;
        
        snapshot.forEach(child => {
            const article = child.val();
            const articleId = child.key;
            count++;
            
            html += `
                <div class="admin-queue-item" id="queue-item-${articleId}">
                    <div style="background: #ffeaa7; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        ‚ö†Ô∏è <strong>–°—Ç–∞—Ç–∏—è—Ç–∞ –µ –æ–¥–æ–±—Ä–µ–Ω–∞, –Ω–æ –Ω–µ –µ –≤ –æ–ø–∞—à–∫–∞—Ç–∞!</strong>
                        <button onclick="addToQueue('${articleId}')" style="margin-left: 10px; padding: 3px 8px; font-size: 12px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            –î–æ–±–∞–≤–∏ –≤ –æ–ø–∞—à–∫–∞
                        </button>
                    </div>
                    <h3>${article.title || '–ë–µ–∑ –∑–∞–≥–ª–∞–≤–∏–µ'}</h3>
                    <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${article.author || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                    <p><strong>–†–µ–¥–∞–∫—Ç–æ—Ä:</strong> ${article.redactorId || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                    <p><strong>–û–¥–æ–±—Ä–µ–Ω–∞:</strong> ${new Date(article.approvedAt || article.date).toLocaleDateString('bg-BG')}</p>
                    ${article.redactorNotes ? `<p><strong>–ë–µ–ª–µ–∂–∫–∏:</strong> ${article.redactorNotes}</p>` : ''}
                    <div class="queue-actions">
                        <button onclick="previewArticle('${articleId}')" class="btn-small">üëÅÔ∏è –ü—Ä–µ–≥–ª–µ–¥</button>
                        <button onclick="publishArticle('${articleId}')" class="btn-small btn-success">‚úÖ –ü—É–±–ª–∏–∫—É–≤–∞–π</button>
                        <button onclick="returnToRedactor('${articleId}')" class="btn-small btn-warning">‚Ü©Ô∏è –í—ä—Ä–Ω–∏ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
                    </div>
                </div>
            `;
        });
        
        articlesContainer.innerHTML = html;
        console.log(`‚úÖ Loaded ${count} approved articles directly`);
        
    } catch (error) {
        console.error('Error loading approved articles:', error);
        document.getElementById('adminQueueContainer').innerHTML = 
            '<div class="empty-state">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç–∏–∏—Ç–µ.</div>';
    }
}

// Helper: Add missing article to queue
async function addToQueue(articleId) {
    if (!confirm('–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞ –≤ –æ–ø–∞—à–∫–∞—Ç–∞ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ?')) return;
    
    try {
        const articleSnap = await firebase.database().ref(`articles/${articleId}`).once('value');
        const article = articleSnap.val();
        
        if (!article) {
            alert('–°—Ç–∞—Ç–∏—è—Ç–∞ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞!');
            return;
        }
        
        const queueData = {
            articleId: articleId,
            redactorId: article.redactorId,
            redactorName: article.redactorName || article.redactorId || 'Unknown',
            redactorEmail: article.redactorEmail,
            approvedAt: article.approvedAt || Date.now(),
            title: article.title,
            author: article.author,
            excerpt: article.excerpt || article.content?.substring(0, 200) || '',
            category: article.category || 'general',
            timestamp: Date.now(),
            manuallyAdded: true
        };
        
        await firebase.database().ref(`queues/adminQueue/${articleId}`).set(queueData);
        alert('‚úÖ –°—Ç–∞—Ç–∏—è—Ç–∞ –µ –¥–æ–±–∞–≤–µ–Ω–∞ –≤ –æ–ø–∞—à–∫–∞—Ç–∞!');
        loadArticleQueue(); // Refresh
    } catch (error) {
        alert('‚ùå –ì—Ä–µ—à–∫–∞: ' + error.message);
    }
}
    </script>
</body>
</html>

